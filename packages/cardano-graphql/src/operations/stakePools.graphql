fragment certificateTransactionFields on Transaction {
  block {
    blockNo
  }
  hash
}

fragment allPoolParameterFields on PoolParameters {
  metadata {
    ticker
    name
    description
    homepage
    extDataUrl
    extSigUrl
    extVkey
    ext {
      serial
      pool {
        id
        country
        status
        contact {
          primary
          email
          facebook
          github
          feed
          telegram
          twitter
        }
        media_assets {
          icon_png_64x64
          logo_png
          logo_svg
          color_fg
          color_bg
        }
        itn {
          owner
          witness
        }
      }
    }
  }
  owners {
    address
  }
  cost
  margin {
    numerator
    denominator
  }
  vrf
  relays {
    __typename
    ... on RelayByName {
      hostname
      port
    }
    ... on RelayByAddress {
      ipv4
      ipv6
      port
    }
    ... on RelayByNameMultihost {
      dnsName
    }
  }
  poolRegistrationCertificate {
    transaction {
      hash
    }
  }
  rewardAccount {
    address
  }
  pledge
  metadataJson {
    hash
    url
  }
}

fragment allStakePoolFields on StakePool {
  id
  hexId
  status
  # Review: not sure this is correct. Consider this situation:
  # pool registration tx at blockNo:1, specifying epoch:4
  # pool registration tx at blockNo:2, specifying epoch:3
  # Is stake pool active at epoch 3 and then switches to new parameters at epoch 4?
  # Current implementation will ignore the 2nd transaction, as it's ordered by epoch first.
  # I assume we also need to order by tx index in block as there can be multiple txes for registration of the same stake pool?
  # TODO: apply same in block.graphql
  poolParameters(order: { desc: sinceEpochNo, then: { desc: transactionBlockNo } }, first: 1) {
    ...allPoolParameterFields
  }
  metrics {
    blocksCreated
    livePledge
    stake {
      live
      active
    }
    size {
      live
      active
    }
    saturation
    delegators
  }
  poolRetirementCertificates {
    transaction {
      ...certificateTransactionFields
    }
  }
}

query StakePoolsByMetadata(
  $query: String!
  $omit: [String!] = ["NEED_THIS_BECAUSE_IN_OPERATOR_WONT_WORK_WITH_EMPTY_ARR"]
) {
  queryStakePoolMetadata(
    filter: {
      and: [
        { or: [{ name: { anyoftext: $query } }, { ticker: { anyoftext: $query } }] }
        { not: { stakePoolId: { in: $omit } } }
      ]
    }
  ) {
    poolParameters {
      stakePool {
        ...allStakePoolFields
      }
    }
  }
}

query StakePools($query: String!) {
  queryStakePool(filter: { id: { anyoftext: $query } }) {
    ...allStakePoolFields
  }
}
